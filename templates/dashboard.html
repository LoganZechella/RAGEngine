{% extends "base.html" %}

{% block content %}
<div class="p-6">
    <!-- Header -->
    <div class="mb-8">
        <h2 class="text-3xl font-bold text-white mb-2">Breath Diagnostics Knowledge Base</h2>
        <p class="text-gray-400">Manage and search your specialized document collections</p>
    </div>

    {% if error %}
        <div class="bg-red-900 border border-red-700 text-red-200 px-4 py-3 rounded mb-6">
            <strong>Error:</strong> {{ error }}
        </div>
    {% endif %}

    <!-- Collection Overview Cards -->
    <div class="mb-8">
        <h3 class="text-xl font-semibold text-white mb-4">üìö Document Collections</h3>
        <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-4">
            {% if collection_stats %}
                {% for collection_name, stats in collection_stats.items() %}
                <div class="bg-gray-800 rounded-lg p-4 hover:bg-gray-750 transition-colors cursor-pointer"
                     onclick="selectCollection('{{ collection_name }}')">
                    <div class="flex items-center justify-between mb-2">
                        <h4 class="font-medium text-white">{{ stats.display_name }}</h4>
                        <span class="text-2xl">
                            {% if collection_name == 'sop_policy' %}üìã
                            {% elif collection_name == 'clinical_studies' %}üè•
                            {% elif collection_name == 'research_data' %}üî¨
                            {% elif collection_name == 'regulatory_documents' %}‚öñÔ∏è
                            {% elif collection_name == 'legacy_documents' %}üìú
                            {% elif collection_name == 'training_materials' %}üéì
                            {% else %}üìÑ{% endif %}
                        </span>
                    </div>
                    <p class="text-gray-400 text-sm mb-3">{{ stats.description }}</p>
                    <div class="flex justify-between items-center text-sm">
                        <span class="text-blue-400">{{ stats.document_count }} docs</span>
                        {% if stats.status == 'green' %}
                            <span class="text-green-400">‚úÖ Active</span>
                        {% else %}
                            <span class="text-yellow-400">‚ö†Ô∏è {{ stats.status }}</span>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div class="col-span-full bg-gray-800 rounded-lg p-6 text-center">
                    <p class="text-gray-400">Loading collection information...</p>
                    <button 
                        hx-get="/collection-stats" 
                        hx-target="#dashboard-container"
                        class="mt-2 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors"
                    >
                        Load Collections
                    </button>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Enhanced Search Interface -->
    <div class="bg-gray-800 rounded-lg p-6 mb-8">
        <h3 class="text-xl font-semibold text-white mb-4">üîç Search Knowledge Base</h3>
        
        <form hx-post="/search-with-progress" hx-target="#search-container" hx-trigger="submit" class="space-y-4" id="search-form">
            <div class="grid grid-cols-1 lg:grid-cols-4 gap-4">
                <!-- Search Query -->
                <div class="lg:col-span-2">
                    <input 
                        type="text" 
                        name="query" 
                        id="search-query"
                        placeholder="Enter your search query..." 
                        class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white placeholder-gray-400 focus:outline-none focus:border-blue-500"
                        required
                    >
                </div>
                
                <!-- Collection Selection -->
                <div>
                    <select name="collections" multiple id="collection-select" 
                            class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white focus:outline-none focus:border-blue-500">
                        <option value="all" selected>All Collections</option>
                        {% if collection_stats %}
                            {% for collection_name, stats in collection_stats.items() %}
                            <option value="{{ collection_name }}">{{ stats.display_name }}</option>
                            {% endfor %}
                        {% endif %}
                    </select>
                    <p class="text-xs text-gray-400 mt-1">Hold Ctrl to select multiple</p>
                </div>
                
                <!-- Search Options -->
                <div class="flex items-center space-x-2">
                    <select name="mode" class="bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white focus:outline-none focus:border-blue-500">
                        <option value="hybrid">Hybrid</option>
                        <option value="dense">Semantic</option>
                        <option value="sparse">Keyword</option>
                    </select>
                    
                    <label class="flex items-center space-x-1 text-gray-300">
                        <input type="checkbox" name="synthesize" checked class="rounded bg-gray-700 border-gray-600 text-blue-600">
                        <span class="text-sm">AI Analysis</span>
                    </label>
                </div>
            </div>
            
            <!-- Collection Quick Filters -->
            <div class="flex flex-wrap gap-2 text-sm">
                <span class="text-gray-400">Quick filters:</span>
                <button type="button" class="collection-filter text-blue-400 hover:text-blue-300 underline" data-collection="sop_policy">SOPs & Policies</button>
                <button type="button" class="collection-filter text-blue-400 hover:text-blue-300 underline" data-collection="clinical_studies">Clinical Studies</button>
                <button type="button" class="collection-filter text-blue-400 hover:text-blue-300 underline" data-collection="regulatory_documents">Regulatory</button>
                <button type="button" class="collection-filter text-blue-400 hover:text-blue-300 underline" data-collection="current_documents">Current Docs</button>
            </div>
            
            <button 
                type="submit" 
                id="search-button"
                class="w-full bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg transition-colors flex items-center justify-center space-x-2"
            >
                <span class="search-icon">üîç</span>
                <span>Search Selected Collections</span>
            </button>
        </form>
        
        <div id="search-container" class="mt-6"></div>
    </div>

    <!-- Collection Management Section -->
    <div class="bg-gray-800 rounded-lg p-6 mb-8">
        <h3 class="text-xl font-semibold text-white mb-4">üóÑÔ∏è Collection Management</h3>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- File Upload with Collection Assignment -->
            <div>
                <h4 class="font-medium text-white mb-3">üìÅ Upload Documents</h4>
                <form hx-post="/upload-to-collection" hx-target="#upload-status" hx-encoding="multipart/form-data" class="space-y-4">
                    <div class="border-2 border-dashed border-gray-600 rounded-lg p-6 text-center">
                        <input type="file" name="files" multiple accept=".pdf,.txt,.html" class="hidden" id="file-input">
                        <label for="file-input" class="cursor-pointer">
                            <div class="text-4xl mb-2">üìé</div>
                            <p class="text-gray-300 mb-2">Click to select files</p>
                            <p class="text-gray-500 text-sm">PDF, TXT, HTML supported</p>
                        </label>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <select name="target_collection" class="bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white">
                            <option value="">Auto-classify</option>
                            {% if collection_stats %}
                                {% for collection_name, stats in collection_stats.items() %}
                                <option value="{{ collection_name }}">{{ stats.display_name }}</option>
                                {% endfor %}
                            {% endif %}
                        </select>
                        
                        <button type="submit" class="bg-green-600 hover:bg-green-700 text-white py-2 rounded-lg transition-colors">
                            Upload & Process
                        </button>
                    </div>
                </form>
                
                <div id="upload-status" class="mt-4"></div>
            </div>
            
            <!-- Collection Actions -->
            <div>
                <h4 class="font-medium text-white mb-3">‚öôÔ∏è Collection Actions</h4>
                <div class="space-y-3">
                    <div class="flex items-center space-x-3">
                        <select id="target-collection" class="flex-1 bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white">
                            {% if collection_stats %}
                                {% for collection_name, stats in collection_stats.items() %}
                                <option value="{{ collection_name }}">{{ stats.display_name }}</option>
                                {% endfor %}
                            {% endif %}
                        </select>
                        <button 
                            onclick="clearCollection()"
                            class="bg-yellow-600 hover:bg-yellow-700 text-white px-4 py-2 rounded-lg transition-colors"
                        >
                            Clear
                        </button>
                    </div>
                    
                    <button 
                        hx-get="/collection-stats" 
                        hx-target="#collection-stats"
                        class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 rounded-lg transition-colors"
                    >
                        Refresh Collection Stats
                    </button>
                    
                    <div id="collection-stats" class="mt-4"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- System Overview -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
        <!-- Total Documents -->
        <div class="bg-gray-800 rounded-lg p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-400 text-sm">Total Documents</p>
                    <p class="text-2xl font-semibold text-white">
                        {% if collection_stats %}
                            {{ collection_stats.values() | map(attribute='document_count') | sum }}
                        {% else %}
                            Loading...
                        {% endif %}
                    </p>
                </div>
                <div class="w-12 h-12 bg-green-600 rounded-lg flex items-center justify-center">
                    <span class="text-2xl">üìö</span>
                </div>
            </div>
        </div>

        <!-- Active Collections -->
        <div class="bg-gray-800 rounded-lg p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-400 text-sm">Active Collections</p>
                    <p class="text-2xl font-semibold text-white">
                        {% if collection_stats %}
                            {{ collection_stats | length }}
                        {% else %}
                            Loading...
                        {% endif %}
                    </p>
                </div>
                <div class="w-12 h-12 bg-blue-600 rounded-lg flex items-center justify-center">
                    <span class="text-2xl">üóÑÔ∏è</span>
                </div>
            </div>
        </div>

        <!-- Vector Dimensions -->
        <div class="bg-gray-800 rounded-lg p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-400 text-sm">Vector Dimensions</p>
                    <p class="text-2xl font-semibold text-white">
                        {{ system_info.search_config.vector_dimensions if system_info else "1536" }}
                    </p>
                </div>
                <div class="w-12 h-12 bg-purple-600 rounded-lg flex items-center justify-center">
                    <span class="text-2xl">üìä</span>
                </div>
            </div>
        </div>
    </div>

    <!-- System Information -->
    <div class="bg-gray-800 rounded-lg p-6">
        <h3 class="text-xl font-semibold text-white mb-4">‚öôÔ∏è System Information</h3>
        <button 
            hx-get="/system-info" 
            hx-target="#system-info-content" 
            class="mb-4 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors"
        >
            Refresh System Info
        </button>
        <div id="system-info-content"></div>
    </div>
</div>

<script>
// Collection management JavaScript
function selectCollection(collectionName) {
    const select = document.getElementById('collection-select');
    if (!select) return;
    
    // Clear all selections
    for (let option of select.options) {
        option.selected = false;
    }
    // Select the clicked collection
    for (let option of select.options) {
        if (option.value === collectionName) {
            option.selected = true;
            break;
        }
    }
}

function clearCollection() {
    const select = document.getElementById('target-collection');
    const collection = select.value;
    
    if (!collection) {
        alert('Please select a collection to clear');
        return;
    }
    
    if (confirm(`Are you sure you want to clear all documents from ${collection}? This action cannot be undone.`)) {
        fetch(`/collection/${collection}/clear`, {
            method: 'POST'
        })
        .then(response => response.text())
        .then(result => {
            document.getElementById('collection-stats').innerHTML = result;
            // Refresh collection stats
            const refreshButton = document.querySelector('[hx-get="/collection-stats"]');
            if (refreshButton) {
                refreshButton.click();
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to clear collection');
        });
    }
}

// Collection filter buttons
document.addEventListener('DOMContentLoaded', function() {
    const filterButtons = document.querySelectorAll('.collection-filter');
    filterButtons.forEach(button => {
        button.addEventListener('click', function() {
            const collection = this.dataset.collection;
            selectCollection(collection);
        });
    });
    
    // File input change event
    const fileInput = document.getElementById('file-input');
    if (fileInput) {
        fileInput.addEventListener('change', function() {
            const files = this.files;
            const label = this.nextElementSibling || this.parentElement.querySelector('label');
            if (files.length > 0) {
                const fileText = files.length === 1 ? files[0].name : `${files.length} files selected`;
                label.querySelector('p').textContent = fileText;
            }
        });
    }
});
</script>
{% endblock %} 